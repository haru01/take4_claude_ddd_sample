# TODOリストが完了基準を満たしているかを確認

---
name: check_todo_completion

args:

- name: index
  short: i
  description: TODOのインデックス番号（例: create_training）
  required: true

---

## 使用例

```
/check_todo_completion index=create_training"
/check_todo_completion i=create_training"
```
## 実行内容

TODO-{{index}}.mdで定義されたストーリー実現の成功基準を満たしているかを自動判定します。
コード品質とテストカバレッジを重視した包括的な評価を行います。

## 使用方法

このコマンドは以下の手順で成功基準をチェックします：

1. TODO.mdの解析とタスク進捗確認
2. コード品質の検証
3. テストカバレッジの測定
4. 受け入れ条件の達成度評価
5. 総合判定とレポート生成

## 成功基準定義

### 1. 基本品質基準（必須）

- **TypeScript型チェック**: エラー0件
- **ビルド成功**: 必須
- **全テスト成功**: 100%パス率

### 2. テストカバレッジ基準

- **全体カバレッジ**: 85%以上
- **ドメイン層**: 95%以上（ビジネスロジック重要）
- **関数カバレッジ**: 90%以上
- **ブランチカバレッジ**: 80%以上

### 3. 機能別成功基準（TODO.mdベース）

#### ドメイン層の実装品質

- [ ] 新機能のドメイン関数が実装されている
- [ ] 引数・戻り値の型が適切に定義されている
- [ ] バリデーション関数が実装されている
- [ ] ビジネスルールが正しく実装されている
- [ ] Zodスキーマ検証が実装されている

#### テスト実装品質

- [ ] ドメイン層のテストファイルが存在する
- [ ] 正常系テストが実装されている
- [ ] 異常系テストが実装されている
- [ ] 境界値テストが実装されている
- [ ] 状態遷移テストが実装されている
- [ ] skipされたテストが0件

#### アプリケーション層の実装品質

- [ ] コマンドスキーマが定義されている
- [ ] ハンドラー関数が実装されている
- [ ] TaskEitherパイプラインが使用されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] アプリケーション層のテストが存在する

### 4. コード品質基準

#### DDD原則の遵守

- [ ] ドメイン関数の純粋性が保たれている
- [ ] 適切な責任分離（Domain/Application/Infrastructure）
- [ ] Value Objectが適切に使用されている
- [ ] 集約の境界が明確に定義されている

#### 関数型プログラミング原則

- [ ] TaskEitherが適切に使用されている
- [ ] 副作用が適切に分離されている
- [ ] Immutabilityが維持されている
- [ ] パイプライン処理が実装されている

### 5. TODO.md進捗基準

#### タスク完了率

- [ ] ドメイン層タスクの完了率が90%以上
- [ ] アプリケーション層タスクの完了率が90%以上
- [ ] テスト関連タスクの完了率が100%
- [ ] 全体タスクの完了率が95%以上

#### 受け入れ条件の達成

- [ ] TODO.mdに記載された受け入れ条件がすべて満たされている
- [ ] ユーザーストーリーが完全に実装されている
- [ ] 質問事項に対する回答が実装に反映されている

## 実行手順

### ステップ1: 環境チェック

```bash
# 基本環境の確認
node --version
npm --version
npm list --depth=0
```

### ステップ2: コード品質チェック

```bash
# TypeScript型チェック
npm run type-check

# ビルドチェック
npm run build
```

### ステップ3: テスト実行とカバレッジ測定

```bash
# テスト実行（カバレッジ付き）
npm run test -- --coverage

# カバレッジレポートの確認
cat coverage/coverage-summary.json
```

### ステップ4: 実装確認

```bash
# TODO.mdで定義された機能のファイル存在確認
find src/ -name "*.ts" -type f | grep -E "(domain|application)" | head -20
find tests/ -name "*.test.ts" -type f | head -20

# skipされたテストの確認
grep -r "it.skip\|describe.skip" tests/ || echo "skipされたテストはありません"
```

### ステップ5: TODO.md進捗確認

```bash
# チェックボックスの完了状況を確認
echo "完了タスク: $(grep -c '\[x\]' TODO.md)件"
echo "未完了タスク: $(grep -c '\[ \]' TODO.md)件"
echo "進捗率: $(echo "scale=1; $(grep -c '\[x\]' TODO.md) * 100 / ($(grep -c '\[x\]' TODO.md) + $(grep -c '\[ \]' TODO.md))" | bc)%"
```

## 判定基準

### 🟢 成功（PASS）

- 基本品質基準をすべて満たす
- テストカバレッジが目標値以上
- TODO.mdのタスクが95%以上完了
- 受け入れ条件が100%達成

### 🟡 警告（WARNING）

- 基本品質基準は満たすが、カバレッジが目標未達
- TODO.mdのタスクが80%以上完了
- 一部の実装品質基準が未達

### 🔴 失敗（FAIL）

- TypeScriptエラーまたはテスト失敗がある
- TODO.mdのタスクが80%未満
- 重要な機能が実装されていない

## 自動レポート生成

チェック結果を以下の形式でレポート出力：

```
# 成功基準チェック結果レポート

## 実行日時
YYYY-MM-DD HH:MM:SS

## 総合判定
🟢 成功 / 🟡 警告 / 🔴 失敗

## 詳細結果

### コード品質
- TypeScript型チェック: ✅/❌ (X件のエラー)
- ビルド: ✅/❌
- テスト成功率: ✅/❌ XX% (XX/XX tests)

### テストカバレッジ
- 全体: ✅/❌ XX% (目標: 85%)
- ドメイン層: ✅/❌ XX% (目標: 95%)
- 関数: ✅/❌ XX% (目標: 90%)

### TODO.md進捗
- 完了タスク: XX/XX (XX%)
- ドメイン層: XX/XX (XX%)
- アプリケーション層: XX/XX (XX%)
- テスト関連: XX/XX (XX%)

### 実装品質チェック
- ドメイン関数: ✅/❌
- テストファイル: ✅/❌
- スキーマ定義: ✅/❌
- skipテスト: ✅/❌ (X件残存)

## 改善提案
- [ ] 未完了タスクの完了
- [ ] テストカバレッジの向上
- [ ] skipされたテストの有効化
- [ ] 型安全性の改善
```

## 継続的な改善

### メトリクス追跡

- テストカバレッジの推移
- TODO完了率の推移
- コード品質スコアの推移

### ベンチマーク設定

- プロジェクト標準値との比較
- 過去実装との品質比較
- 業界ベストプラクティスとの比較

### 完了している場合の追加のテスト観点

完了と判断した場合、あらためて以下の観点で開発者に提案してください

- [ ] TODO実現に関連のみで、リファクタリングした方が良いことの提案
- [ ] ユーザビリティの観点は？
- [ ] セキュリティは妥当か？
- [ ] スケーラビリティの懸念点は？
- [ ] ドメインスキーマ型定義の疑問点は？
- [ ] 状態遷移の事前条件、事後条件のテストケースの抜け漏れは？
- [ ] アプリーケーションの非同期処理を含んだ例外フロー
